<script>
    export let placeholder = "Rechercher...";
    export let value = ""; // Initialiser avec une chaîne vide
    export let onSearch = () => {};

    export let isSearching = false;
    let results = []; // Tableau pour stocker les résultats de l'API

    // Réinitialiser la valeur de l'input au chargement de la page
    if (typeof window !== 'undefined') {
        value = ""; // Réinitialiser la valeur
        setTimeout(() => {
            const inputElement = document.querySelector('.search-bar input');
            if (inputElement) {
                inputElement.value = ""; // Effacer manuellement le champ d'entrée
            }
        }, 0);
    }

    async function fetchResults(query) {
        if (!query) {
            results = []; // Si aucune requête, vider les résultats
            return;
        }

        try {
            const token = localStorage.getItem('sessionToken'); // Récupérer le token depuis le localStorage
            if (!token) {
                console.error("Token JWT non trouvé dans le localStorage");
                results = [];
                return;
            }

            const response = await fetch(`http://localhost:81/storage/uploads/search?q=${encodeURIComponent(query)}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`, // Utiliser le token récupéré
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                console.error("Erreur lors de l'appel à l'API :", response.statusText);
                results = [];
                return;
            }

            const data = await response.json();
            results = data.uploads || []; // Stocker les résultats dans le tableau
        } catch (error) {
            console.error("Erreur lors de la requête :", error);
            results = [];
        }
    }

    function handleInput(event) {
        value = event.target.value;
        fetchResults(value); // Appeler l'API avec la valeur actuelle
        onSearch(value);
        if (!isSearching) {
            isSearching = true;
        }
    }

    function handleKeydown(event) {
        if (event.key === "Escape") {
            isSearching = false;
            value = "";
            results = []; // Vider les résultats en quittant la recherche
        }
    }
</script>

<div
    class="search-container {isSearching ? 'searching' : ''}"
    on:keydown={handleKeydown}
    tabindex="0"
>
    <div class="logo-and-bar">
        <img
            src="/logo.png"
            alt="Logo"
            class="logo {isSearching ? 'logo-small' : ''}"
        />
        <div class="relative search-bar">
            <input
                type="text"
                bind:value={value}
                on:input={handleInput}
                placeholder={placeholder}
                class="w-full px-6 py-4 text-lg text-gray-700 bg-gray-100 border border-gray-300 rounded-full shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500"
            />
        </div>
    </div>
</div>

<style>
    .search-container {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 90vh;
        width: 60vw;
        transition: all 0.1s ease-in-out;
        position: relative;
        margin: auto;
    }

    .search-container.searching {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        background-color: rgba(255, 255, 255, 0);
        z-index: 10;
        padding: 10px 20px;
        justify-content: flex-start;
        align-items: flex-start;
    }

    .logo-and-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.1s ease-in-out;
    }

    .search-container.searching .logo-and-bar {
        flex-direction: row;
        align-items: center;
        width: 100%;
    }

    .logo {
        width: 150px;
        height: auto;
        transition: all 0.1s ease-in-out;
        margin-bottom: 20px;
    }

    .search-container.searching .logo {
        width: 80px;
        margin-bottom: 0;
        margin-right: 20px;
    }

    .search-bar {
        width: 120%; /* Augmente la largeur du conteneur de 20% */
        transition: all 0.1s ease-in-out;
    }

    input {
        width: 100%; /* L'input occupe toute la largeur du conteneur */
        font-size: 1.5rem;
        padding: 1rem 2rem;
        border-radius: 3.1416px;
        border: none; /* Supprime les bordures */
        outline: none; /* Supprime le contour bleu de Firefox */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        color: rgba(12, 78, 77, 0.715);
        background-color: rgba(5, 88, 96, 0.097);
    }

    .search-container.searching input {
        font-size: 1rem; /* Réduire la taille de la police */
        padding: 0.8rem 1.5rem; /* Réduire le padding */
        width: 45%;
    }

    input:focus {
        background-color: #ffffff;
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    }

    /* Media queries pour écrans moyens */
    @media (max-width: 1024px) {
        .search-container {
            width: 80vw; /* Réduire la largeur */
        }

        input {
            font-size: 1.3rem; /* Réduire la taille de la police */
            padding: 0.8rem 1.5rem; /* Réduire le padding */
        }

        .logo {
            width: 120px; /* Réduire la taille du logo */
        }
    }

    /* Media queries pour petits écrans */
    @media (max-width: 768px) {
        .search-container {
            width: 90vw; /* Réduire encore plus la largeur */
        }

        input {
            font-size: 1.1rem; /* Réduire la taille de la police */
            padding: 0.6rem 1rem; /* Réduire le padding */
        }

        .logo {
            width: 100px; /* Réduire la taille du logo */
        }
    }

    /* Media queries pour très petits écrans */
    @media (max-width: 480px) {
        .search-container {
            width: 95vw; /* Utiliser presque toute la largeur disponible */
        }

        input {
            font-size: 1rem; /* Réduire encore plus la taille de la police */
            padding: 0.5rem 0.8rem; /* Réduire le padding */
        }

        .logo {
            width: 80px; /* Réduire encore plus la taille du logo */
        }
    }
</style>